---
title: "Untitled"
author: "Dexter Howard"
date: "2024-09-06"
output: html_document
---

```{r}
library(tidyverse)
```

## Read in data and format 

```{r}
#read in scores 
Scored_forecasts <- read_csv("../Data/allReservoir_allmodel_4cast_Scores.csv") |> 
  mutate(Horizon = datetime - reference_datetime) |> 
  filter(Horizon > 0, Horizon < 17) |> 
  mutate(model_id = ifelse(model_id == "fable_persistence", "Persist", model_id),
         model_id = ifelse(model_id == "climatology", "Clim", model_id),
         model_id = ifelse(model_id == "fDOM_AR_dwh", "AR", model_id),
         model_id = ifelse(model_id == "fDOM_RainLag_dwh", "RainLag", model_id),
         model_id = ifelse(model_id == "fDOM_MetRegression_dwh", "MetRegress", model_id),
         model_id = ifelse(model_id == "fableNNETAR", "NNETAR", model_id)
         ) |>  #update model names for plotting
   mutate(model_type = ifelse(model_id %in% c("Persist", "Clim"), "Null", NA),
         model_type = ifelse(model_id %in% c("NNETAR"), "ML", model_type),
         model_type = ifelse(model_id %in% c("AR", "RainLag", "MetRegress"), "Empirical", model_type)
         ) #grouping by model types


```


## Summary Plots over Horizons

Mean of all models across horizon
```{r}
#all metrics
Scored_forecasts |> 
  filter(reference_datetime >= ymd("2023-02-01"),
         reference_datetime <= ymd("2024-08-01")) |> 
  group_by(Horizon, site_id) |> 
  summarise(RMSE = round(sqrt(mean((mean - observation)^2, na.rm = TRUE)), 2),
            CRPS = mean(crps, na.rm = T),
            SD = mean(sd, na.rm = T)
            ) |>
  pivot_longer(-c(1:2)) |> 
  group_by(Horizon, name) |> #get line for all sites
  mutate(value_all = mean(value, na.rm = T)) |> #get line for all sites
  ggplot(aes(x = Horizon, y = value, color = site_id))+ 
  geom_line(linewidth = 1.2)+
  geom_line(aes(x = Horizon, y = value_all, color = "all"), linewidth = 1.2)+  #get line for all sites
  facet_wrap(~name, scales = "free_y")+
  scale_x_continuous(breaks = c(1,4,7,10,13,16))+ #c(1,3,5,7,9,11,13,15)
  labs(x = "Horizon", color = "Reservoir", title = "Mean across models")+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))+
  scale_color_manual(values = c("all" = "black", "fcre" = "#009E73", "bvre" = "orange", "ccre" = "skyblue"))


```


Best model across horizon
```{r}
#determine best models by site
Scored_forecasts |> 
  group_by(site_id, model_id) |> 
    summarise(RMSE = round(sqrt(mean((mean - observation)^2, na.rm = TRUE)), 2),
            CRPS = mean(crps, na.rm = T),
            SD = mean(sd, na.rm = T)
            ) 

#determine best model across reservoirs
Scored_forecasts |> 
  group_by(model_id) |> 
    summarise(RMSE = round(sqrt(mean((mean - observation)^2, na.rm = TRUE)), 2),
            CRPS = mean(crps, na.rm = T),
            SD = mean(sd, na.rm = T)
            ) 
  

#all metrics
Scored_forecasts |> 
  filter(reference_datetime >= ymd("2023-02-01"),
         reference_datetime <= ymd("2024-08-01")) |> 
  filter(model_id == ifelse(site_id %in% c("fcre", "bvre"), "Persist", "AR")) |> #get just highest performing
  group_by(Horizon, site_id, model_id) |> 
  summarise(RMSE = round(sqrt(mean((mean - observation)^2, na.rm = TRUE)), 2),
            CRPS = mean(crps, na.rm = T),
            SD = mean(sd, na.rm = T)
            ) |>
  pivot_longer(-c(1:3)) |> 
  ggplot(aes(x = Horizon, y = value, color = site_id, linetype = model_id))+ 
  geom_line(linewidth = 1.2)+
  facet_wrap(~name, scales = "free_y")+
  scale_x_continuous(breaks = c(1,4,7,10,13,16))+ #c(1,3,5,7,9,11,13,15)
  labs(x = "Horizon", color = "Reservoir", title = "Best Model by Reservoir")+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))+
  scale_color_manual(values = c("fcre" = "#009E73", "bvre" = "orange", "ccre" = "skyblue"))


```


All models and reservoirs over horizon 
```{r}
#CRPS, RMSE, SD in one 
Scored_forecasts |> 
  filter(reference_datetime >= ymd("2023-02-01"),
         reference_datetime <= ymd("2024-08-01")) |> 
  group_by(Horizon, site_id, model_id, model_type) |> 
  summarise(RMSE = round(sqrt(mean((mean - observation)^2, na.rm = TRUE)), 2),
            CRPS = mean(crps, na.rm = T),
            SD = mean(sd, na.rm = T)) |>
  pivot_longer(-c(1:4)) |> 
  ggplot(aes(x = Horizon, y = value, color = model_id, linetype = model_type))+ 
  geom_line(linewidth = 1.2)+
  #geom_point(size = 3)+
  facet_grid(name~site_id, scales = "free_y")+
  scale_x_continuous(breaks = c(1,3,5,7,9,11,13,15))+
  labs(x = "Horizon")+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))+
  scale_color_manual(values = c("AR" = "#CC6677", "Clim" = "#88CCEE", "Persist" = "#DDCC77", 
                              "NNETAR" = "#117733", "RainLag" = "#332288", "MetRegress" = "#888888"))+
  scale_linetype_manual(values = c("Empirical" = 1, "ML" = 2, "Null" = 3))


```




## Skill by season 

mean of models 
```{r}
#metric ~ reservoirs
Scored_forecasts |> 
  mutate(Julian = yday(datetime),
         Season = ifelse(Julian >= 54 & Julian <= 68, "Spring", NA),
         Season = ifelse(Julian >= 69 & Julian <= 307, "Summer", Season),
         Season = ifelse(Julian >= 308 & Julian <= 353, "Fall", Season),
         Season = ifelse(Julian >= 354 | Julian <= 53, "Winter", Season)
         ) |> 
  filter(reference_datetime >= ymd("2023-02-01"),
         reference_datetime <= ymd("2024-08-01")) |> 
  group_by(Horizon, site_id, Season) |> 
  summarise(RMSE = round(sqrt(mean((mean - observation)^2, na.rm = TRUE)), 2),
            CRPS = mean(crps, na.rm = T),
            SD = mean(sd, na.rm = T)
            ) |>
  pivot_longer(-c(1:3)) |> 
  group_by(Horizon, site_id, name) |> 
  mutate(value_all = mean(value, na.rm = T)) |> 
  ggplot(aes(x = Horizon, y = value, color = Season))+ 
  geom_line(linewidth = 1.2)+
  geom_line(aes(x = Horizon, y = value_all, color = "all"), linewidth = 1.2)+
  facet_grid(name~site_id, scales = "free_y")+
  scale_x_continuous(breaks = c(1,4,7,10,13,16))+ #c(1,3,5,7,9,11,13,15)
  labs(x = "Horizon", color = "Reservoir", title = "Mean across models")+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))+
  scale_color_manual(values = c("all" = "black", "Fall" = "orange", "Spring" = "turquoise", 
                              "Summer" = "green4", "Winter" = "gray"))


#metric ~ Seasons
Scored_forecasts |> 
  mutate(Julian = yday(datetime),
         Season = ifelse(Julian >= 54 & Julian <= 68, "Spring", NA),
         Season = ifelse(Julian >= 69 & Julian <= 307, "Summer", Season),
         Season = ifelse(Julian >= 308 & Julian <= 353, "Fall", Season),
         Season = ifelse(Julian >= 354 | Julian <= 53, "Winter", Season)
         ) |> 
  filter(reference_datetime >= ymd("2023-02-01"),
         reference_datetime <= ymd("2024-08-01")) |> 
  group_by(Horizon, site_id, Season) |> 
  summarise(RMSE = round(sqrt(mean((mean - observation)^2, na.rm = TRUE)), 2),
            CRPS = mean(crps, na.rm = T),
            SD = mean(sd, na.rm = T)
            ) |>
  pivot_longer(-c(1:3)) |> 
  group_by(Horizon, Season, name) |> 
  mutate(value_all = mean(value, na.rm = T)) |> 
  ggplot(aes(x = Horizon, y = value, color = site_id))+ 
  geom_line(linewidth = 1.2)+
  geom_line(aes(x = Horizon, y = value_all, color = "all"), linewidth = 1.2)+
  facet_grid(name~Season, scales = "free_y")+
  scale_x_continuous(breaks = c(1,4,7,10,13,16))+ #c(1,3,5,7,9,11,13,15)
  labs(x = "Horizon", color = "Reservoir", title = "Mean across models")+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))+
  scale_color_manual(values = c("all" = "black", "fcre" = "#009E73", "bvre" = "orange", "ccre" = "skyblue"))


```

best model: just taking model from above

```{r}
Scored_forecasts |> 
  mutate(Julian = yday(datetime),
         Season = ifelse(Julian >= 54 & Julian <= 68, "Spring", NA),
         Season = ifelse(Julian >= 69 & Julian <= 307, "Summer", Season),
         Season = ifelse(Julian >= 308 & Julian <= 353, "Fall", Season),
         Season = ifelse(Julian >= 354 | Julian <= 53, "Winter", Season)
         ) |> 
  filter(reference_datetime >= ymd("2023-02-01"),
         reference_datetime <= ymd("2024-08-01")) |> 
  filter(model_id == ifelse(site_id %in% c("fcre", "bvre"), "Persist", "AR")) |> #get just highest performing
  group_by(Horizon, site_id, model_id, Season) |> 
  summarise(RMSE = round(sqrt(mean((mean - observation)^2, na.rm = TRUE)), 2),
            CRPS = mean(crps, na.rm = T),
            SD = mean(sd, na.rm = T)
            ) |>
  pivot_longer(-c(1:4)) |> 
  ggplot(aes(x = Horizon, y = value, color = site_id, linetype = model_id))+ 
  geom_line(linewidth = 1.2)+
  facet_grid(name~Season, scales = "free_y")+
  scale_x_continuous(breaks = c(1,4,7,10,13,16))+ #c(1,3,5,7,9,11,13,15)
  labs(x = "Horizon", color = "Reservoir", title = "Best models")+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))+
  scale_color_manual(values = c("all" = "black", "fcre" = "#009E73", "bvre" = "orange", "ccre" = "skyblue"))


```



all models and reservoirs
```{r}
#rmse
Scored_forecasts |> 
  mutate(Julian = yday(datetime),
         Season = ifelse(Julian >= 54 & Julian <= 68, "Spring", NA),
         Season = ifelse(Julian >= 69 & Julian <= 307, "Summer", Season),
         Season = ifelse(Julian >= 308 & Julian <= 353, "Fall", Season),
         Season = ifelse(Julian >= 354 | Julian <= 53, "Winter", Season)
         ) |> 
  filter(reference_datetime >= ymd("2023-02-01"),
         reference_datetime <= ymd("2024-08-01")) |> 
  group_by(Horizon, site_id, model_id, Season) |> 
  summarise(RMSE = round(sqrt(mean((mean - observation)^2, na.rm = TRUE)), 2)) |>
  ggplot(aes(x = Horizon, y = RMSE, color = model_id))+ # color = model_id
  geom_line(linewidth = 1.2)+
  # geom_point(size = 3)+
  facet_grid(site_id~Season)+
  scale_x_continuous(breaks = c(1,3,5,7,9,11,13,15))+
  labs(x = "Horizon", y = "RMSE (QSU)")+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))+
  scale_color_manual(values = c("AR" = "#CC6677", "Clim" = "#88CCEE", "Persist" = "#DDCC77", 
                              "NNETAR" = "#117733", "RainLag" = "#332288", "MetRegress" = "#888888"))


```


## Residual timeseries

```{r}
#resid 
for (i in unique(Scored_forecasts$model_id)) {
  fig <- Scored_forecasts |> 
  filter(reference_datetime >= ymd("2023-02-01")) |> 
  filter(model_id == i,
         Horizon %in% c(1,8,16)) |> 
  mutate(Horizon_label = ifelse(Horizon == 1, "1 day ahead", NA),
         Horizon_label = ifelse(Horizon == 8, "8 days ahead", Horizon_label),
         Horizon_label = ifelse(Horizon == 16, "16 days ahead", Horizon_label)) |> 
  mutate(resid = mean - observation) |> 
  ggplot()+
  geom_point(aes(x = as.Date(datetime), y = resid))+
  facet_grid(site_id~factor(Horizon_label, levels = c("1 day ahead", "8 days ahead", "16 days ahead")), scales = "free_y")+
  scale_x_date(date_breaks = "6 month", date_labels = "%b %y" )+
  ylim(-10, 10)+
  labs(x = element_blank(), y = "Resid (mean predicted - observered)", title = i)+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 14))
  
    print(fig)

      }# end for loop

```


## TS w/ ribbon as forecast 

```{r}
#### FCR All 6 models w/ 1, 8, 16 horizons

for (i in unique(Scored_forecasts$model_id)) {
  print(i)
  
  fig <- Scored_forecasts |> 
  filter(reference_datetime >= ymd("2023-02-01")) |> 
  filter(model_id == i,
         Horizon %in% c(1,8,16),
         site_id == 'fcre') |> 
  mutate(Horizon_label = ifelse(Horizon == 1, "1 day ahead", NA),
         Horizon_label = ifelse(Horizon == 8, "8 days ahead", Horizon_label),
         Horizon_label = ifelse(Horizon == 16, "16 days ahead", Horizon_label)) |> 
  ggplot()+
  geom_ribbon(aes(x = as.Date(datetime), ymin = quantile02.5, ymax = quantile97.5), fill = "gray", alpha = 0.5)+
  geom_line(aes(x = as.Date(datetime), y = mean))+
  geom_point(aes(x = as.Date(datetime), y = observation))+
  facet_wrap(~factor(Horizon_label, levels = c("1 day ahead", "8 days ahead", "16 days ahead")), ncol = 1, scales = "free_y")+
  scale_x_date(date_breaks = "2 month", date_labels = "%b %y" )+
  labs(x = element_blank(), y = "fDOM (QSU)", title = i)+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 14))
  
  print(fig)
  
}


#### FCR All models faceted
Scored_forecasts |> 
  filter(reference_datetime >= ymd("2023-02-01")) |> 
  filter(Horizon %in% c(1,8,16),
         site_id == 'fcre') |> 
  mutate(Horizon_label = ifelse(Horizon == 1, "1 day ahead", NA),
         Horizon_label = ifelse(Horizon == 8, "8 days ahead", Horizon_label),
         Horizon_label = ifelse(Horizon == 16, "16 days ahead", Horizon_label)) |> 
  ggplot()+
  geom_ribbon(aes(x = as.Date(datetime), ymin = quantile02.5, ymax = quantile97.5), fill = "gray", alpha = 0.5)+
  geom_line(aes(x = as.Date(datetime), y = mean))+
  geom_point(aes(x = as.Date(datetime), y = observation))+
  facet_grid(factor(Horizon_label, levels = c("1 day ahead", "8 days ahead", "16 days ahead"))~model_id, scales = "free_y")+
  scale_x_date(date_breaks = "6 month", date_labels = "%b %y" )+
  labs(x = element_blank(), y = "fDOM (QSU)", title = "FCR")+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 14))



### All reservoirs and models at 1 day 
Scored_forecasts |> 
  filter(reference_datetime >= ymd("2023-02-01")) |> 
  filter(Horizon %in% c(1)) |> 
  mutate(Horizon_label = ifelse(Horizon == 1, "1 day ahead", NA)) |> 
  ggplot()+
  geom_ribbon(aes(x = as.Date(datetime), ymin = quantile02.5, ymax = quantile97.5), fill = "gray", alpha = 0.5)+
  geom_line(aes(x = as.Date(datetime), y = mean))+
  geom_point(aes(x = as.Date(datetime), y = observation))+
  facet_grid(site_id~model_id, scales = "free_y")+
  scale_x_date(date_breaks = "6 month", date_labels = "%b %y" )+
  labs(x = element_blank(), y = "fDOM (QSU)")+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 14))
  
  


```


## Example forecast plots

```{r}
####just forecast horizon w/ ribbons and observations
Scored_forecasts |> 
  filter(reference_datetime == ymd("2024-07-01")) |> 
  ggplot()+
  #geom_point(aes(datetime, observation)) +
  geom_ribbon(aes(x = datetime, ymin = quantile02.5, ymax = quantile97.5, fill = model_id), alpha = 0.2)+
  geom_line(aes(x = datetime, y = mean, col = model_id))+
  facet_wrap(~site_id, scales = "free") +
  # geom_vline(xintercept = ymd("2023-04-16"))
  labs(x = 'datetime', y = 'fDOM (QSU)') +
  guides(x =  guide_axis(angle = 30)) +
  theme_bw() + theme(legend.position = "top", text = element_text(size = 14))


#### Plot week before and no observations in forecast
#set up data
weekbefore <- Scored_forecasts |> 
    filter(datetime <= ymd("2024-07-15"),
           datetime >= ymd("2024-07-15") - 7) |> 
  select(datetime, observation, model_id, site_id)

example_forecast_data <- Scored_forecasts |> 
  filter(reference_datetime == ymd("2024-07-15"))
  
#plot it
example_forecast_data |> 
  plyr::rbind.fill(weekbefore) |> 
  mutate(observation = ifelse(datetime > ymd("2024-07-15"), NA, observation)) |> 
  ggplot()+
  geom_point(aes(datetime, observation)) +
  geom_vline(aes(xintercept = as.Date("2024-07-15")))+
  geom_ribbon(aes(x = datetime, ymin = quantile02.5, ymax = quantile97.5, fill = model_id), alpha = 0.2)+
  geom_line(aes(x = datetime, y = mean, color = model_id))+
  facet_wrap(~site_id, scales = "fixed") +
  labs(x = 'datetime', y = 'fDOM (QSU)', fill = "model", color = "model") +
  # ylim(0,40)+
  guides(x =  guide_axis(angle = 30)) +
  guides(fill = guide_legend(nrow = 1))+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))

#change orientation for conceputal figure
example_forecast_data |> 
  plyr::rbind.fill(weekbefore) |> 
  mutate(observation = ifelse(datetime > ymd("2024-07-15"), NA, observation)) |> 
  ggplot()+
  geom_point(aes(datetime, observation)) +
  geom_vline(aes(xintercept = as.Date("2024-07-15")))+
  geom_ribbon(aes(x = datetime, ymin = quantile02.5, ymax = quantile97.5, fill = model_id), alpha = 0.2)+
  geom_line(aes(x = datetime, y = mean, color = model_id))+
  facet_wrap(~site_id, scales = "free", nrow = 3) +
  labs(x = 'datetime', y = 'fDOM (QSU)', fill = "model", color = "model") +
  # ylim(0,40)+
  # guides(x =  guide_axis(angle = 30)) +
  guides(fill = guide_legend(nrow = 2))+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))


####Week before and observations in forecast horizon 
example_forecast_data |> 
  plyr::rbind.fill(weekbefore) |> 
  #mutate(observation = ifelse(datetime > ymd("2024-07-15"), NA, observation)) |> 
  ggplot()+
  geom_point(aes(datetime, observation)) +
  geom_vline(aes(xintercept = as.Date("2024-07-15")))+
  geom_ribbon(aes(x = datetime, ymin = quantile02.5, ymax = quantile97.5, fill = model_id), alpha = 0.2)+
  geom_line(aes(x = datetime, y = mean, color = model_id))+
  facet_wrap(~site_id, scales = "fixed") +
  labs(x = 'datetime', y = 'fDOM (QSU)', fill = "model", color = "model") +
  # ylim(0,40)+
  guides(x =  guide_axis(angle = 30)) +
  guides(fill = guide_legend(nrow = 1))+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))



####Facet by site and model 
example_forecast_data |> 
  plyr::rbind.fill(weekbefore) |> 
  #mutate(observation = ifelse(datetime > ymd("2024-07-15"), NA, observation)) |> 
  ggplot()+
  geom_point(aes(datetime, observation)) +
  geom_vline(aes(xintercept = as.Date("2024-07-15")))+
  geom_ribbon(aes(x = datetime, ymin = quantile02.5, ymax = quantile97.5, fill = model_id), alpha = 0.2)+
  geom_line(aes(x = datetime, y = mean))+
  facet_grid(site_id~model_id, scales = "free") +
  labs(x = 'datetime', y = 'fDOM (QSU)', fill = "model", color = "model") +
  # ylim(0,40)+
  guides(x =  guide_axis(angle = 30)) +
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))


```


## Observed fDOM TS

```{r}
#all on one plot
Scored_forecasts |> 
  filter(Horizon == 1) |> 
  ggplot(aes(x = datetime, y = observation, color = site_id))+
  geom_point()+
  scale_x_date(date_breaks = "3 month", date_labels = "%b %y" )+
  labs(x = "Date", y = "fDOM (QSU)", color = "Reservoir")+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))+
  scale_color_manual(values = c("fcre" = "#009E73", "bvre" = "orange", "ccre" = "skyblue"))


#faceted
Scored_forecasts |> 
  filter(Horizon == 1) |> 
  ggplot(aes(x = datetime, y = observation))+
  geom_point()+
  scale_x_date(date_breaks = "3 month", date_labels = "%b %y" )+
  facet_wrap(~site_id, scales = "fixed", ncol = 1)+
  labs(x = "Date", y = "fDOM (QSU)", color = "Reservoir")+
  theme_bw() + theme(legend.position = "top", text = element_text(size = 18))

  
  
```

















